# 2025年1月5日 JVM学习记录

## 学习主题：JVM核心知识点（前22个）

### 知识点3：能说一下JVM的内存区域吗？

**对话：**

老师：JVM的内存区域有哪些？

用户：程序计数器、虚拟机栈、本地方法栈、堆、方法区。

老师：哪些是线程共享的，哪些是线程私有的？

用户：堆和方法区是线程共享的，其他三个是线程私有的。

老师：为什么要有这样的区分？

用户：线程私有的是为了线程安全，共享的是为了数据共享。

老师：对的！程序计数器记录当前线程执行的位置，虚拟机栈存储方法调用信息，本地方法栈处理native方法，堆存放对象实例，方法区存放类信息、常量等。

---

### 知识点4：JDK 1.6、1.7、1.8内存区域的变化？

**对话：**

老师：JDK不同版本内存区域有什么变化？

用户：1.6用永久代实现方法区，1.7把字符串常量池移到堆上，1.8用元空间替代永久代。

老师：为什么1.8要用元空间替代永久代？

用户：永久代容易内存溢出，受JVM内存限制，元空间使用本地内存。

老师：元空间有什么优势？

用户：不会出现永久代OOM，动态调整大小，垃圾回收更高效。

---

### 知识点5：为什么使用元空间替代永久代？

**对话：**

老师：永久代有什么问题？

用户：容易内存溢出，大小固定不好调整。

老师：元空间怎么解决这些问题？

用户：元空间使用本地内存，可以动态扩展，不受JVM堆大小限制。

老师：元空间在什么情况下会内存溢出？

用户：本地内存不足时，或者类加载太多。

---

### 知识点6：对象创建的过程了解吗？

**对话：**

老师：new一个对象时，JVM做了什么？

用户：先检查类是否加载，然后分配内存，初始化对象，设置对象头。

老师：对象头包含什么信息？

用户：类信息、哈希码、GC分代年龄等。

老师：对象初始化时成员变量默认值是什么？

用户：数值类型是0，布尔是false，对象是null。

---

### 知识点7：堆内存是如何分配的？

**对话：**

老师：堆内存分配有哪两种策略？

用户：指针碰撞和空闲列表。

老师：分别适用于什么场景？

用户：指针碰撞适合年轻代，内存规整；空闲列表适合老年代，内存碎片化。

老师：为什么年轻代用指针碰撞？

用户：年轻代对象生命周期短，内存回收后比较规整。

---

### 知识点8：new对象时，堆会发生抢占吗？

**对话：**

老师：多线程new对象会有什么问题？

用户：会发生内存分配竞争。

老师：JVM怎么解决这个问题？

用户：使用TLAB，线程本地分配缓存。

老师：TLAB怎么工作？

用户：每个线程预先分配一小块内存，在自己的TLAB里分配对象，避免竞争。

---

### 知识点9：对象的内存布局？

**对话：**

老师：对象在内存中怎么布局？

用户：对象头、实例数据、对齐填充。

老师：对象头具体包含什么？

用户：Mark Word和类型指针。

老师：对齐填充的作用是什么？

用户：让对象大小是8字节的倍数，提高访问效率。

---

### 知识点10：JVM怎么访问对象？

**对话：**

老师：JVM访问对象有哪两种方式？

用户：句柄和直接指针。

老师：HotSpot用哪种？

用户：直接指针。

老师：直接指针有什么优势？

用户：访问速度快，少一次指针定位。

---

### 知识点11：对象有哪几种引用？

**对话：**

老师：Java有哪几种引用？

用户：强引用、软引用、弱引用、虚引用。

老师：强引用有什么特点？

用户：只要强引用存在，对象就不会被回收。

老师：软引用和弱引用有什么区别？

用户：软引用在内存不足时回收，弱引用在下一次GC时回收。

---

### 知识点12：Java堆的内存分区？

**对话：**

老师：Java堆怎么分区？

用户：新生代和老年代。

老师：新生代又分为什么？

用户：Eden区和两个Survivor区。

老师：对象在堆中怎么流动？

用户：新对象在Eden区，经过多次GC后存活的对象进入老年代。

---

### 知识点13：新生代的区域划分？

**对话：**

老师：新生代为什么分Eden和Survivor？

用户：为了使用标记-复制算法。

老师：Eden和Survivor的比例是多少？

用户：默认8:1:1。

老师：为什么用标记-复制算法？

用户：新生代对象存活率低，复制存活对象效率高。

---

### 知识点14：对象什么时候进入老年代？

**对话：**

老师：对象怎么进入老年代？

用户：年龄计数器达到阈值，或者大对象直接进入。

老师：年龄计数器怎么工作？

用户：每次Minor GC存活，年龄加1，达到15进入老年代。

老师：大对象为什么直接进老年代？

用户：避免在新生代频繁复制，提高效率。

---

### 知识点15：STW了解吗？

**对话：**

老师：什么是STW？

用户：Stop The World，垃圾回收时暂停所有用户线程。

老师：为什么需要STW？

用户：保证对象移动时引用关系不变。

老师：怎么实现安全暂停？

用户：通过安全点机制。

---

### 知识点16：对象一定分配在堆中吗？

**对话：**

老师：对象都在堆上分配吗？

用户：不一定，JVM会做逃逸分析。

老师：什么情况下对象在栈上分配？

用户：对象生命周期只在方法内部，没有逃逸。

老师：栈上分配有什么好处？

用户：方法结束时自动回收，减少GC压力。

---

### 知识点17：内存溢出和内存泄漏？

**对话：**

老师：内存溢出和内存泄漏有什么区别？

用户：溢出是内存不足，泄漏是对象无法回收。

老师：什么情况会导致内存溢出？

用户：创建大量对象，或者内存配置不合理。

老师：内存泄漏常见原因？

用户：静态集合、未关闭的资源、监听器未注销等。

---

### 知识点18：能手写内存溢出的例子吗？

**对话：**

老师：写个堆内存溢出的例子。

用户：
```java
List<byte[]> list = new ArrayList<>();
while(true) {
    list.add(new byte[10 * 1024 * 1024]);
}
```

老师：这个代码会有什么问题？

用户：无限创建10MB数组，很快堆内存耗尽。

老师：怎么避免这种情况？

用户：合理使用内存，及时释放不再使用的对象。

---

### 知识点19：内存泄漏可能由哪些原因导致？

**对话：**

老师：常见的内存泄漏场景？

用户：静态集合、ThreadLocal未清理、连接未关闭。

老师：静态集合为什么会导致泄漏？

用户：静态变量生命周期长，持有的对象无法回收。

老师：ThreadLocal怎么正确使用？

用户：用完后调用remove方法清理。

---

### 知识点20：有没有处理过内存泄漏问题？

**对话：**

老师：处理过内存泄漏吗？

用户：处理过，用jmap分析堆转储文件。

老师：具体怎么排查？

用户：先用jstat看内存变化，再用jmap导出堆文件，用MAT分析。

老师：MAT能看出什么？

用户：能看到对象引用链，找到泄漏的根源。

---

### 知识点21：有没有处理过内存溢出问题？

**对话：**

老师：处理过内存溢出吗？

用户：处理过，上传大文件时内存溢出。

老师：怎么解决的？

用户：限制文件大小，使用流式处理，及时释放内存。

老师：排查过程是怎样的？

用户：先看错误日志，再用jmap导出堆文件分析。

---

### 知识点22：什么情况下会发生栈溢出？

**对话：**

老师：栈溢出是什么原因？

用户：方法调用嵌套太深，栈空间不足。

老师：最常见的情况是什么？

用户：递归调用没有终止条件。

老师：怎么避免栈溢出？

用户：控制递归深度，使用迭代替代递归，增加栈大小。

---

**今日总结：**
今天我们系统学习了JVM的前22个核心知识点，从内存区域划分到垃圾回收机制，从对象创建到内存溢出排查。重点理解了JVM的内存管理机制和各种问题的排查方法。明天我们将继续学习垃圾回收相关的知识点。